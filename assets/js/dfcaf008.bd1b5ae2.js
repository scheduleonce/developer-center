"use strict";(self.webpackChunkdocos=self.webpackChunkdocos||[]).push([[451],{2886:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"recipes/fetch-bookings-periodically","title":"Fetch bookings periodically","description":"Notice that this recipe uses native fetch in Node.js","source":"@site/docs/recipes/fetch-bookings-periodically.md","sourceDirName":"recipes","slug":"/recipes/fetch-bookings-periodically/","permalink":"/developer-center/docs/recipes/fetch-bookings-periodically/","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/recipes/fetch-bookings-periodically.md","tags":[],"version":"current","frontMatter":{"id":"fetch-bookings-periodically","title":"Fetch bookings periodically","slug":"/recipes/fetch-bookings-periodically/"},"sidebar":"docs","previous":{"title":"Contact us","permalink":"/developer-center/docs/developer-support/contact-us/"},"next":{"title":"Fetch bookings periodically","permalink":"/developer-center/docs/recipes/fetch-bookings-periodically/"}}');var i=t(4848),o=t(8453);const c={id:"fetch-bookings-periodically",title:"Fetch bookings periodically",slug:"/recipes/fetch-bookings-periodically/"},r="Import depenencies and declare constants",a={},l=[];function d(e){const n={a:"a",br:"br",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-node",metastring:"Node",children:'import parse from "parse-link-header";\nconst baseUrl = "https://api.oncehub.com";\nconst apiKey = "{{api_key}}";\nconst headers = { "api-key": apiKey };\n\nlet lastFetchTime = new Date();\n\nasync function fetchBookingSince(date) {\n  // here we\'ll store the final results after all pages returned\n  let results = [];\n\n  async function fetchNextPage(url) {\n    const res = await fetch(url, { headers });\n    const data = await res.json();\n    results = results.concat(data.data);\n    const nextUrl = parse(res.headers.get("link"))?.next?.url;\n    if (nextUrl) {\n      await fetchNextPage(nextUrl);\n    }\n  }\n  const res = await fetch(\n    `${baseUrl}/v2/bookings?limit=10&last_updated_time.gt=${lastFetchTime.toJSON()}`,\n    {\n      headers,\n    }\n  );\n  const data = await res.json();\n  results = results.concat(data.data);\n  const nextUrl = parse(res.headers.get("link"))?.next?.url;\n  if (nextUrl) {\n    await fetchNextPage(nextUrl);\n  }\n\n  return results;\n}\n\nasync function fetchPeriodically() {\n  const data = await fetchBookingSince(lastFetchTime);\n  // check if we have any new entries\n  if (data.length) {\n    lastFetchTime = new Date();\n    // here we can do anything else once we get results of new entries\n    // it could be for example to update the database or send an email\n    // or update some remote system\n    console.log(data);\n  } else {\n    console.log("No new booking events");\n  }\n\n  setTimeout(() => {\n    fetchPeriodically();\n  }, 60 * 1000);\n}\n\nfetchPeriodically();\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:"Response Example",children:'{ "success": true }\n'})}),"\n",(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"import-depenencies-and-declare-constants",children:"Import depenencies and declare constants"})}),"\n",(0,i.jsxs)(n.p,{children:["Notice that this recipe uses native fetch in Node.js",(0,i.jsx)(n.br,{}),"\n","This requires node version > 17.6.0 and at the time of writing this script, to run node with the flag ",(0,i.jsx)(n.code,{children:"--experimental-fetch"})," on."]}),"\n",(0,i.jsxs)(n.p,{children:["Read more about fetch api ",(0,i.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API",children:"here"})]}),"\n",(0,i.jsxs)(n.p,{children:["If you are running an older version of Node.js you can import ",(0,i.jsx)(n.a,{href:"https://github.com/node-fetch/node-fetch",children:"node-fetch"}),"."]}),"\n",(0,i.jsx)(n.h1,{id:"put-in-your-oncehub-api-key",children:"Put in your Oncehub API key"}),"\n",(0,i.jsx)(n.h1,{id:"change-the-initial-fetch-time",children:"Change the initial fetch time"}),"\n",(0,i.jsxs)(n.p,{children:["You can set the initial time from which you want to fetch all bookings.",(0,i.jsx)(n.br,{}),"\n","In this case, we are only fetching bookings that were updated since the script has started running."]}),"\n",(0,i.jsx)(n.p,{children:"You can set"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"lastFetchTime = new Date(0)\n"})}),"\n",(0,i.jsx)(n.p,{children:"To get all bookings since the beginning."}),"\n",(0,i.jsx)(n.h1,{id:"fetch-all-bookings-periodically",children:"Fetch all bookings periodically"}),"\n",(0,i.jsx)(n.p,{children:"This is the part where we are polling Oncehub API to fetch bookings periodically"}),"\n",(0,i.jsx)(n.h1,{id:"fetch-period",children:"Fetch period"}),"\n",(0,i.jsx)(n.p,{children:"You can change the polling period from 60 seconds to anything else you want."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>r});var s=t(6540);const i={},o=s.createContext(i);function c(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);